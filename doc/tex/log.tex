\section{Ημερολόγιο}

Μία αναμενόμενη απαίτηση της υλοποίησης είναι η διατήρηση των μετρήσεων για την
μετέπειτα ανάκτηση και επεξεργασία τους με σκοπό την εξαγωγή συμπερασμάτων ή τη
λήψη αποφάσεων για την κατάσταση του μέσου. Το Ημερολόγιο μετρήσεων αναλαμβάνει
τη διαχείριση εγγραφών που παρέχουν αυτήν την πληροφορία.

%
% LogRecord
%

\subsection{Δομή εγγραφής}

Σημείο κεντρικού ενδιαφέροντος του Ημερολογίου είναι οι εγγραφές.
Καθότι ανήκει σε ημερολόγιο, κάθε εγγραφή είναι άρρηκτα συνδεδεμένη με μία
ημερομηνία\slash ώρα (εφεξής αναφερόμενη απλά ως «ημερομηνία»), που προσδιορίζει
τη χρονική τοποθέτησή της και χρησιμεύει ως κριτήριο αναζήτησης -- το μοναδικό
που υποστηρίζεται από το Ημερολόγιο σε αυτήν την υλοποίηση.
Εκτός από την ημερομηνία, τηρούνται και τα στοιχεία της μέτρησης, όπως οι
συντεταγμένες όπου έγινε η δειγματοληψία και, σαφώς, οι ενδείξεις των
αισθητήριων οργάνων. Το σχήμα \ref{fig:log:record} παρουσιάζει τη δομή κάθε
εγγραφής.

\begin{figure}
    \caption{Δομή μίας εγγραφής Ημερολογίου.\label{fig:log:record}}
    \begin{center}\begin{tabu} spread 0pt {|X|X|X|X|X|X|X|X|X|X|X|}


    \multicolumn6{c}{
        $\overbrace{\rule{4cm}{0pt}}^{\text{ημερομηνία}}$}              &
    \multicolumn5{c}{
        $\overbrace{\rule{3.2cm}{0pt}}^{\text{στοιχεία μέτρησης}}$}     \\

    \hline\rowfont[c]{}
    \verb~YY~           &
    \verb~ΜΜ~           &
    \verb~DD~           &
    \verb~HH~           &
    \verb~mm~           &
    \verb~ss~           &
    \verb~X~            &
    \verb~Y~            &
    \verb~Τ~            &
    \verb~RH~           &
    \verb~pH~           \\
    \hline

    \end{tabu}\end{center}
\end{figure}

Είναι φανερό ότι η ημερομηνία καταλαμβάνει ένα πολύ μεγάλο μέρος της εγγραφής
και ο λόγος είναι ότι αναπαριστάται σε BCD. Ο συμβολισμός BCD (Binary-Coded
Decimal notation -- Δυαδικά Κωδικοποιημένος Δεκαδικός συμβολισμός), όπως
χρησιμοποιείται στην προκειμένη, απαιτεί ένα Byte για την αναπαράσταση
οποιουδήποτε αριθμού του δεκαδικού συστήματος αρίθμησης από 0 μέχρι 99· εύρος
ικανό να καλύψει τις ανάγκες του Ημερολογίου.

Κύριος λόγος για την επιλογή του συμβολισμού BCD για την ημερομηνία είναι η
αμεσότητα μετατροπής της από αριθμό σε κείμενο, και αντιστρόφως. Πρακτικά, αυτό
σημαίνει ότι είναι ταχύτερη η μετατροπή της κάθε εγγραφής και, κατ' επέκταση
μίας πληθώρας εγγραφών, σε κείμενο που προορίζεται για εμφάνιση σε χρήστη.
% Παράδειγμα ή αναφορά σε BCDDate.

Το μειονέκτημα είναι ότι δεσμεύεται πολύ περισσότερος χώρος από ότι ουσιαστικά
αξιοποιείται. Για παράδειγμα, το ίδιο εύρος ημερομηνιών θα μπορούσε να καλυφθεί
από έναν αριθμό 32-bit που διατηρεί το πλήθος δευτερολέπτων που έχουν παρέλθει
από την ημερομηνία αναφοράς (την παλαιότερη υποστηριζόμενη ημερομηνία). Ωστόσο,
αυτή η προσέγγιση θα απαιτούσε την αναγωγή των συνιστωσών της ημερομηνίας (έτος,
μήνας, μέρα \etc.) κάθε φορά που χρειαζόταν μία εξ αυτών.

%Από την πλευρά του ημερολογίου, κάθε εγγραφή φέρει, υποχρεωτικά, την ημερομηνία
%και ώρα της. Βάσει αυτής

%Το Ημερολόγιο υλοποιείται θεωρώντας ότι η ημερομηνία κάθε εγγραφής είναι
%μοναδική. Επίσης, η ημερομηνία τίθεται από

\subsubsection{Δομή ημερομηνίας}

Οι συνιστώσες της ημερομηνίας (σχήμα \ref{fig:log:record}), αποτελούν μέλη της
δομής \verb~BCDDate~. Η δομή αυτή έχει οριστεί για την κάλυψη των αναγκών του
Ημερολογίου στην αποθήκευση και αναζήτηση εγγραφών καθώς και για την παροχή ενός
κοινού τρόπου ανταλλαγής ημερομηνιών μεταξύ των δομικών στοιχείων της
υλοποίησης. Ο ορισμός της είναι ο ακόλουθος:
\begin{lstlisting}
typedef struct {
    uint8_t year;
    uint8_t mon;
    uint8_t date;
    uint8_t hour;
    uint8_t min;
    uint8_t sec;
} BCDDate;
\end{lstlisting}

Τα μέλη της έχουν οριστεί σε φθίνουσα σειρά σπουδαιότητας με τρόπο που
διευκολύνεται η σύγκριση μεταξύ ημερομηνιών αυτής της δομής. Αρχικά συγκρίνεται
το πρώτο -- πλέον σημαντικό -- Byte κάθε ημερομηνίας, δηλαδή τα έτη. Εφόσον
είναι ίσα, ακολουθεί σύγκριση με το αμέσως επόμενο, σε σπουδαιότητα, Byte, αυτό
του μήνα, και η διαδικασία συνεχίζεται για όλα τα Byte ή έως ότου εντοπιστεί
κάποια διαφοροποίηση, η οποία κρίνει και το ποια ημερομηνία είναι μεγαλύτερη.
Η διαδικασία σύγκρισης που ακολουθείται είναι ίδια με αυτήν μεταξύ δύο μη
προσημασμένων αριθμών μεγάλου μήκους.

%
% LogRecordSet
%

\subsection{Ομάδα εγγραφών}
Τυπικά, δοθέντων δύο ημερομηνιών, το Ημερολόγιο είναι σε θέση να επιστρέψει όλες
τις ενδιάμεσες εγγραφές. Ωστόσο, η άμεση και μαζική επιστροφή τους είναι
απαγορευτική λόγω των περιορισμένων πόρων του μικροελεγκτή καθώς απαιτείται
δέσμευση χώρου στην κύρια μνήμη, δυνητικά, για όλες τις εγγραφές του
Ημερολογίου.
%
%Επιπλέον, απαιτείται
%η προσπέλαση του υποκείμενου αποθηκευτικού μέσου για την ανάκτηση εγγραφών εκ
%των οποίων μόλις ένα μικρό μέρος μπορεί να έχει ενδιαφέρον στην εκάστοτε
%περίπτωση. Για παράδειγμα, παρότι έχουν δοθεί δύο ημερομηνίες που καλύπτουν όλο
%το εύρος των εγγραφών, μπορεί να πρέπει να επιστραφούν σε μία εξωτερική οντότητα
%μόνο οι πρώτες δέκα, καθώς τα αποτελέσματα έχουν ζητηθεί να επιστραφούν
%σελιδοποιημένα. Είναι σαφές πως μία τέτοια τακτική μειώνει σημαντικά την απόδοση
%του συστήματος.

Αντιθέτως, η προσπέλαση των εγγραφών πραγματοποιείται σε βήματα. Αρχικά,
εκτελείται αναζήτηση βάσει των επιθυμητών ημερομηνιών από όπου επιστρέφεται το
πλήθος των εγγραφών που εντοπίστηκαν, καθώς και μία δομή \verb~LogRecordSet~. H
δομή αυτή αναπαριστά το σύνολο (ή ομάδα) των εντοπισμένων εγγραφών.
Ωστόσο, στην πραγματικότητα, περιέχει μόνο την πληροφορία που επιτρέπει να
εξαχθεί η επόμενη εγγραφή.
Για την οποιαδήποτε επενέργεια στις πραγματικές εγγραφές, παρέχονται ξεχωριστές
συναρτήσεις, κάθε μία δεχόμενη τη δομή \verb~LogRecordSet~. Με τον τρόπο αυτό
γίνεται γνωστή η κατάσταση του τρέχοντος συνόλου ώστε να προσαρμόζεται
καταλλήλως η συμπεριφορά της εκάστοτε συνάρτησης, ενώ δίνεται η δυνατότητα
ενημέρωσης της δομής μετά την ολοκλήρωση των εργασιών.

%Για τις τρέχουσες απαιτήσεις της υλοποίησης, η δομή \verb~LogRecordSet~ ορίζεται
%ως ακολούθως:
%\begin{flushleft}
%\begin{verbatim}
%typedef struct {
%    uint8_t index;
%    uint8_t count;
%} LogRecordSet;
%\end{verbatim}
%\end{flushleft}

%Το μέλος \verb~index~ αναπαριστά τη θέση. \verb~count~

\subsection{Οργάνωση εγγραφών}

Στο σημείο αυτό αναλύεται πώς διαχειρίζεται το Ημερολόγιο τον αφιερωμένο
αποθηκευτικό χώρο για τις εγγραφές του. Παρότι περιγράφονται δύο σχεδιασμοί,
ωστόσο, αποτελούν όψεις του ίδιου νομίσματος· και οι δύο υλοποιούνται σε κώδικα
και λειτουργούν ο ένας πάνω από τον άλλο, προσδίδοντας διαφορετικά επίπεδα
αφαίρεσης. Στο πρώτο κομμάτι περιγράφεται  ενώ στο δεύτερο, πώς υλοποιείται η
διαχείριση των εγγραφών σε φυσικό επίπεδο.

\subsubsection{Επίπεδο κυλιόμενου πίνακα}
Σε υψηλό αφαιρετικό επίπεδο, ο αποθηκευτικός χώρος νοείται ως ένας μονοδιάστατος
πίνακας, εκτεταμένος σε διαδοχικές θέσεις μνήμης, κάθε στοιχείο του οποίου είναι
μία εγγραφή. Οι εγγραφές τοποθετούνται σε αύξουσα σειρά βάσει της ημερομηνίας
τους, με την παλαιότερη να βρίσκεται πάντα στην πρώτη θέση του πίνακα.

Υπό φυσιολογικές συνθήκες, κάθε νέα εγγραφή διαθέτει ημερομηνία μεγαλύτερη των
υπαρχόντων και, συνεπώς, προστίθεται μετά την τρέχουσα τελευταία εγγραφή.
Ωστόσο, η τροποποίηση των ρυθμίσεων της συσκευής -- για την ακρίβεια της
ημερομηνίας\slash ώρας --  είναι πιθανό να προκαλέσει την παραγωγή νέων εγγραφών
με ημερομηνία που προηγείται ορισμένων αποθηκευμένων εγγραφών. Η νέα εγγραφή
διατηρείται πάντα, σύμφωνα με την πεποίθηση ότι οι νέες ρυθμίσεις που προκαλούν
αυτήν τη χρονική ασυνέχεια, έχουν γίνει με σκοπό τη διόρθωση μίας εσφαλμένης
κατάστασης της συσκευής. Το ερώτημα τίθεται για τις παλαιότερα αποθηκευμένες
εγγραφές που διαθέτουν, πλέον, νεότερη ημερομηνία σε σχέση με κάποια νέα
εγγραφή.

Εάν διατηρούνται, τότε μετρήσεις που έχουν γίνει σε παρελθοντικό χρόνο
αναμιγνύονται με τις νέες μετρήσεις, ενδεχομένως, νοθεύοντας τα αποτελέσματά
τους, εφόσον υπάρχουν αποκλίσεις μεταξύ παλαιών και νέων. Για την αποφυγή
τέτοιων αβεβαιοτήτων, το Ημερολόγιο απορρίπτει τις προϋπάρχουσες εγγραφές, η
ημερομηνία των οποίων έπεται κάποιας νέας, προς αποθήκευση, εγγραφής.

Οι επιλογές που έχουν περιγραφεί μέχρι στιγμής, καθιστούν δυνατή την προσπέλαση
υπαρχόντων και την εισαγωγή νέων εγγραφών σε σταθερό χρόνο, ενώ επιτρέπουν την
εύρεση εγγραφών βάσει ημερομηνίας σε χρόνο $O(\log n)$ (μέσω δυαδικής
αναζήτησης). Και τα δύο είναι χαρακτηριστικά που εγγυούνται μειωμένο πλήθος
προσβάσεων στη συσκευή μόνιμης αποθήκευσης, η οποία, κατά πάσα πιθανότητα,
χαρακτηρίζεται από υψηλότερους χρόνους προσπέλασης. Ένα δεύτερο πλεονέκτημα
είναι η κατά το μέγιστο αξιοποίηση του αφιερωμένου αποθηκευτικού χώρου καθώς
αποθηκεύονται μόνο πραγματικά δεδομένα και όχι δευτερεύοντα βοηθητικά (όπως, για
παράδειγμα, δείκτες επόμενου στοιχείου στην περίπτωση χρήσης συνδεδεμένης
λίστας).
Βέβαια, όλα αυτά είναι άμεση απόρροια της
έλλειψης ανάγκης για ενημέρωση και διαγραφή εγγραφών.

Ένα τελευταίο χαρακτηριστικό του Ημερολογίου είναι η αντιμετώπιση της εξάντλησης
του διαθέσιμου αποθηκευτικού χώρου. Σε αυτήν την περίπτωση, επιλέγεται η
απόρριψη της παλαιότερης εγγραφής με την (νοητή) μετακίνηση του πίνακα κατά μία
θέση ώστε να δημιουργηθεί μία νέα θέση στο τέλος του (εξού και ο χαρακτηρισμός
ως «κυλιόμενος»). Σαφώς, ο αντίστοιχος μηχανισμός αναλαμβάνεται από χαμηλότερο
επίπεδο της υλοποίησης. Ωστόσο, αξίζει να σημειωθεί ότι στο μεγαλύτερο κομμάτι
της υλοποίησης ο αποθηκευτικός χώρος αντιμετωπίζεται με αυτόν τον τρόπο· ως ένας
πίνακας όπου το πρώτο του στοιχείο είναι η παλαιότερη εγγραφή, το πραγματικό
περιεχόμενο της οποίας αλλάζει ανά πάσα στιγμή, και ότι οι εγγραφές εκτείνονται
σε αύξουσα σειρά και καλύπτουν μερικώς ή πλήρως τις θέσεις του πίνακα.

\subsubsection{Επίπεδο κυκλικής ουράς}

Επειδή κύριας σημασίας είναι η διατήρηση των τελευταίων μετρήσεων, σε περίπτωση
εξάντλησης του διαθέσιμου αποθηκευτικού χώρου, οι νέες εγγραφές αντικαθιστούν
τις παλαιότερες. Η συμπεριφορά αυτή μπορεί να αποδοθεί από μία απλουστευμένη
μορφή δακτυλίου (ή κυκλικής ουράς), όπου επιτρέπεται μόνο η εισαγωγή στοιχείων
στη δομή με υποστήριξη επικάλυψης των παλαιοτέρων. Βέβαια στην πραγματικότητα, ο
χώρος αποθήκευσης είναι ένας πίνακας από διαδοχικά Byte ή, λίγο πιο αφαιρετικά,
από διαδοχικές θέσεις μεγέθους \verb~LogRecord~. Προκειμένου να υλοποιηθεί η
συμπεριφορά του δακτυλίου, απαιτείται η τήρηση ενός δείκτη που προσδιορίζει τη
θέση του πρώτου στοιχείου καθώς και ενός δεύτερου δείκτη για την τελευταία
\parencite[131]{kolias04}. Ωστόσο, αντί για δείκτη τέλους, τηρείται το πλήθος
των διαθέσιμων εγγραφών. Αυτό έχει το πλεονέκτημα ότι είναι άμεσα γνωστό το
πλήθος των εγγραφών χωρίς να απαιτούνται αλγεβρικές πράξεις για την εξαγωγή του
και, κυρίως, διευκολύνει την αναγνώριση ενός πλήρως γεμάτου από έναν πλήρως
άδειο δακτύλιο (περιπτώσεις κατά τις οποίες οι δείκτες αρχής και τέλους έχουν
την ίδια τιμή).

Στο σχήμα \ref{fig:log:structure} παρουσιάζεται πώς αντιστοιχίζονται
αμφιμονοσήμαντα τα στοιχεία του ιδεατού κυλιόμενου πίνακα
(\ref{fig:log:structure}α) με τα στοιχεία όπως αυτά είναι πραγματικά
αποθηκευμένα στην κυκλική ουρά (\ref{fig:log:structure}β). Σημειώνεται το
εμφανές, ότι για την αναγωγή από το ένα στοιχείο στο άλλο απαιτείται σταθερός
χρόνος.

\begin{figure}
    \caption{Λογικά επίπεδα δομής αποθήκευσης.\label{fig:log:structure}}
    \begin{center}%
    \def\svgwidth{0.7\textwidth}
    \input{img/log_structure.pdf_tex}
    \end{center}
\end{figure}
